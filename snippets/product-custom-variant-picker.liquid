<!-- /snippets/product-variant-options.liquid -->

<div class="product__block__variants-custom ">
  <style>
    .custom-variant-picker {
      display: flex;
    }
    .custom-variant-picker .custom-option {
      width: 56px;
      height: 56px;
      padding: 2px;
      display: flex;
      border-radius: 8px;
      border: 2px solid transparent;
      transition: 0.3s all;
    }
    .custom-variant-picker .custom-option:hover {
      border-color: #000000;
    }

    .custom-variant-picker .custom-option.selected {
      border-color: #000000;
    }
    .custom-variant-picker .custom-option .bg-option {
      width: 100%;
      height: 100%;
      background-repeat: no-repeat !important;
      background-size: cover !important;
      background-position: center center !important;
      border-radius: 4px;
    }
    .form__selectors {
      margin-bottom: 24px;
    }
    .with-guideline .product__info__link {
      font-family: "Helvetica Neue";
      margin: 0;
      padding: 0;


      {% comment %} new styling {% endcomment %}
      color: var(--Text-Primary, #000);
      leading-trim: both;
      text-edge: cap;
      
      /* Text/Button Small */
      font-style: normal;
      font-weight: 500;
      line-height: 150%; /* 18px */
      letter-spacing: 2px;
      text-decoration-line: underline;
      text-decoration-style: solid;
      text-decoration-skip-ink: auto;
      text-decoration-thickness: auto;
      text-underline-offset: auto;
      text-underline-position: from-font;
      text-transform: uppercase;

      gap: 5px;
      background: none;
    }
    .with-guideline .radio__legend {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      row-gap: 12px;
      opacity: 1;
    }
    .product__block__variants-custom {
      margin-top: 24px;
    }


    .product__info__link {
      margin: 0px !important;
    }

    /* Hide the orphaned custom option links that appear outside the structure */
    .product__block__variants-custom > a.radio__button.custom-option {
      display: none !important;
      visibility: hidden !important;
      position: absolute !important;
      left: -9999px !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    .radio__legend__label {
      {% comment %} text-transform: uppercase !important; {% endcomment %}
      font-style: normal;
      font-weight: 500 !important;
      line-height: 150%;
    }

    @media screen and (max-width: 767px) {
      .custom-variant-picker .custom-option {
        width: 44px;
        height: 44px;
        padding: 3px;
        display: flex;
        border-radius: 8px;
        border: 2px solid var(--Gray-300, #EAECF0);
        transition: 0.3s all;
      }

      .radio__inputs--equal {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
      }

      .radio__fieldset .radio__button label {
        padding: 8px 0px;
      }

      .product__block__variants-custom {
        margin-top: 20px;
      }
    }
  </style>

  {% if product.metafields.custom.related_products_stone.value != blank %}
    {% assign count = 0 %}
    {% for related_product in product.metafields.custom.related_products_stone.value %}
      {% if related_product.metafields.custom.product_material.value.label
          == product.metafields.custom.product_material.value.label
      %}
        {% unless related_product.id == product.id %}
          {% assign count = count | plus: 1 %}
          {% assign featureImageOption = related_product.featured_image | img_url: '128x128' %}
          {% if related_product.metafields.custom.stone_image != blank %}
            {% assign featureImageOption = related_product.metafields.custom.stone_image | img_url: '128x128' %}
          {% endif %}
          <a
            class="radio__button custom-option"
            href="/products/{{ related_product.handle }}"
            style="display: none !important; position: absolute; left: -9999px; opacity: 0; pointer-events: none;"
          >
            <span
              class="bg-option"
              style="background: url('{{ featureImageOption }}')"
            ></span>
          </a>
        {% endunless %}
      {% endif %}
    {%- endfor -%}

    <div class="form__selectors custom-variant-picker {% if count == 0 %}hidden hide{% endif %}">
      <div
        data-swapper-wrapper
        data-split-select-wrapper
        class="selector-wrapper selector-wrapper--color selector-wrapper--fullwidth"
      >
        <fieldset class="radio__fieldset">
          <legend class="radio__legend" aria-label="{{ option.name | escape_once }}">
            <span class="radio__legend__label">{{ 'products.product.stone_option_label' | t }}:</span>
            <span data-option-value data-swapper-target>
              {%- if product.metafields.custom.stone_name != blank -%}
                {{- product.metafields.custom.stone_name -}}
              {%- else -%}
                {{- product.title -}}
              {%- endif -%}
            </span>
          </legend>
          {%- if is_swatch_option -%}
            {%- assign lock_width_class = 'radio__inputs--swatch' -%}
          {%- endif -%}

          <div class="radio__inputs {{ lock_width_class }}">
            {% comment %} Current option first {% endcomment %}
            <a class="radio__button custom-option selected" href="/products/{{ product.handle }}">
            {% assign featureImageOption = product.featured_image | img_url: '128x128' %}
            {% if product.metafields.custom.stone_image != blank %}
              {% assign featureImageOption = product.metafields.custom.stone_image | img_url: '128x128' %}
            {% endif %}
              <span
                class="bg-option"
                style="background: url('{{ featureImageOption }}')"
              ></span>
            </a>

            {% comment %} Filter and display related products by material {% endcomment %}
            {% if product.metafields.custom.product_material.value != blank %}
              {% for related_product in product.metafields.custom.related_products_stone.value %}
                {% if related_product.metafields.custom.product_material.value.label
                    == product.metafields.custom.product_material.value.label
                %}
                  {% unless related_product.id == product.id %}
                    {% assign featureImageOption = related_product.featured_image | img_url: '128x128' %}
                    {% if related_product.metafields.custom.stone_image != blank %}
                      {% assign featureImageOption = related_product.metafields.custom.stone_image | img_url: '128x128' %}
                    {% endif %}
                    
                    <a class="radio__button custom-option" href="/products/{{ related_product.handle }}">
                      <span
                        class="bg-option"
                        style="background: url('{{ featureImageOption }}')"
                      ></span>
                    </a>
                  {% endunless %}
                {% endif %}
              {%- endfor -%}
            {% else %}
              {% comment %} If no material filter, show all related products {% endcomment %}
              {% for related_product in product.metafields.custom.related_products_stone.value %}
                {% unless related_product.id == product.id %}
                   {% assign featureImageOption = related_product.featured_image | img_url: '128x128' %}
                    {% if related_product.metafields.custom.stone_image != blank %}
                      {% assign featureImageOption = related_product.metafields.custom.stone_image | img_url: '128x128' %}
                    {% endif %}
                  <a class="radio__button custom-option" href="/products/{{ related_product.handle }}">
                    <span
                      class="bg-option"
                      style="background: url('{{ featureImageOption }}')"
                    ></span>
                  </a>
                {% endunless %}
              {%- endfor -%}
            {% endif %}
          </div>
        </fieldset>
      </div>
    </div>
  {% endif %}

  {% if product.metafields.custom.related_products_material_option.value != blank %}
    {% comment %} Collect unique materials from related_products_material_option {% endcomment %}
    {% assign unique_materials = product.metafields.custom.product_material.value.label %}
    {% assign current_material_label = product.metafields.custom.product_material.value.label %}

    {% for material_option in product.metafields.custom.related_products_material_option.value %}
      {% if material_option.metafields.custom.product_material.value != blank %}
        {% assign material_label = material_option.metafields.custom.product_material.value.label %}
        {% unless unique_materials contains material_label %}
          {% if unique_materials == '' %}
            {% assign unique_materials = material_label %}
          {% else %}
            {% assign unique_materials = unique_materials | append: '|' | append: material_label %}
          {% endif %}
        {% endunless %}
      {% endif %}
    {% endfor %}

    {% assign unique_materials_array = unique_materials | split: '|' %}

    <div class="form__selectors custom-variant-picker">
      <div
        data-swapper-wrapper
        data-split-select-wrapper
        class="selector-wrapper selector-wrapper--color selector-wrapper--fullwidth"
      >
        <fieldset class="radio__fieldset">
          <legend class="radio__legend" aria-label="{{ option.name | escape_once }}">
            <span class="radio__legend__label">{{ 'products.product.material_option_label' | t }}:</span>
            <span data-option-value data-swapper-target>{{ current_material_label }}</span>
          </legend>
          {%- if is_swatch_option -%}
            {%- assign lock_width_class = 'radio__inputs--swatch' -%}
          {%- endif -%}
          <div class="radio__inputs {{ lock_width_class }}">
            {% comment %} Show products for each unique material {% endcomment %}
            {% for material_label in unique_materials_array %}
              {% comment %} Find product in related_products_material_option by material label {% endcomment %}
              {% assign material_product_handle = '' %}
              {% assign material_image = '' %}

              {% for material_option in product.metafields.custom.related_products_material_option.value %}
                {% if material_option.metafields.custom.product_material.value.label == material_label %}
                  {% assign material_product_handle = material_option.handle %}
                  {% assign material_image = material_option.metafields.custom.product_material.value.image %}
                  {% break %}
                {% endif %}
              {% endfor %}

              {% comment %} Check if current product has this material {% endcomment %}
              {% if material_label == current_material_label %}
                <a class="radio__button custom-option selected" href="/products/{{ product.handle }}">
                  <span
                    class="bg-option"
                    style="background: url('{{ product.metafields.custom.product_material.value.image | img_url: '128x128' }}')"
                  ></span>
                </a>
              {% else %}
                <a class="radio__button custom-option" href="/products/{{ material_product_handle }}">
                  <span class="bg-option" style="background: url('{{ material_image | img_url: '128x128' }}')"></span>
                </a>
              {% endif %}
            {%- endfor -%}
          </div>
        </fieldset>
      </div>
    </div>
  {% endif %}

  {%- unless product.has_only_default_variant -%}
    <div class="form__selectors">
      <!-- /snippets/product-size-and-remaining.liquid -->
      {% assign guidelineShowed = false %}
      {%- if block.settings.info_page != blank -%}
        {%- liquid
          assign size_page = pages[block.settings.info_page]
          assign size_page_title = block.settings.title | default: size_page.title
          assign action_style = 'product__info__link'
        -%}
      {%- endif -%}

      {% comment %} Preorder products show a variant countdown but not sold out or in stock states {% endcomment %}
      {%- if product.metafields.theme.preorder.value == true -%}
        {% assign is_preorder = true %}
      {% endif %}

      {%- capture size_chart -%}
            {%- if block.settings.info_page != blank -%}
              <a href="{{ size_page.url }}" class="{{ action_style }}" data-popup-{{ section.id }}="size-{{ section.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="21" viewBox="0 0 20 21" fill="none">
                  <path d="M7.26562 18.7031L1.79688 13.2344L12.7344 2.29688L18.2031 7.76562L7.26562 18.7031Z" stroke="black" stroke-width="1.5"/>
                  <path d="M7.26562 7.76562L9.60937 10.1094" stroke="black" stroke-width="1.5"/>
                  <path d="M4.53125 10.5L6.875 12.8437" stroke="black" stroke-width="1.5"/>
                  <path d="M10 5.03125L12.3437 7.375" stroke="black" stroke-width="1.5"/>
                </svg>
                {{ size_page_title }}
              </a>
              <div class="modal micromodal-slide" id="size-{{ section.id }}" data-modal aria-hidden="true">
                <div class="modal__overlay" tabindex="-1" data-micromodal-close>
                  <button data-micromodal-close class="modal__close" aria-label="{{ 'general.accessibility.close' | t }}"></button>
                  <div class="modal__container modal__container--inline"
                    data-modal-content
                    role="dialog"
                    aria-modal="true"
                    aria-label="{{ size_page_title | strip_html | escape }}">
                    <div class="rte">{{ size_page.content }}</div>
                  </div>
                </div>
              </div>
            {%- endif -%}
          {%- endcapture -%}

      {%- for option in product.options_with_values -%}
        {% comment %} Use select over radio for long inputs and mismatched lengths {% endcomment %}
        {%- liquid
          assign longest_value = 0
          assign shortest_value = 100
          for value in option.values
            if value.size > longest_value
              assign longest_value = value.size
            endif

            if value.size < shortest_value
              assign shortest_value = value.size
            endif
          endfor

          assign lock_width_class = ''
          assign chars_diff = longest_value | minus: shortest_value
          if chars_diff < 5 and longest_value < 6
            assign lock_width_class = 'radio__inputs--equal'
          endif

          assign variant_style = 'dropdown'
          if settings.variant_form == 'button'
            assign variant_style = 'button'
          endif
          if settings.variant_form == 'auto' and longest_value < 16
            assign variant_style = 'button'
          endif
        -%}
        {%- if settings.swatches_enable -%}
          {%- comment -%} Determine if current option matches swatch handle translations {%- endcomment -%}
          {%- capture swatch_translation -%}{{ 'general.swatches.color' | t }} {%- endcapture -%}
          {%- assign translation_array = swatch_translation | append: ',' | split: ',' | uniq -%}
          {%- assign is_swatch_option = false -%}
          {%- assign option_handle = option.name | downcase | lstrip | rstrip | escape_once -%}
          {%- for translation in translation_array -%}
            {%- assign translation_handle = translation | downcase | lstrip | rstrip | escape_once -%}
            {%- if translation_handle == option_handle -%}
              {%- assign is_swatch_option = true -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
        <div
          data-swapper-wrapper
          data-split-select-wrapper
          class="selector-wrapper {% if is_swatch_option %}selector-wrapper--color{% endif %}{% if is_swatch_option or variant_style == 'button' %} selector-wrapper--fullwidth{% endif %} js"
          data-select-label="{{ option.name }}"
          data-option-position="{{ option.position }}"
        >
          {%- if variant_style == 'button' or is_swatch_option -%}
            {%- assign current_value = current_variant.options[forloop.index0] -%}
            <fieldset class="radio__fieldset {% if block.settings.info_page != blank and guidelineShowed == false %}with-guideline{% endif %}">
              <legend class="radio__legend" aria-label="{{ option.name | escape_once }}">
                {%- if block.settings.info_page != blank and guidelineShowed == false -%}
                  <div class="radio__legend__label__wrapper">
                    <span class="radio__legend__label">{{ option.name | escape_once }}:</span>
                    <span data-option-value data-swapper-target>{{ current_value }}</span>
                  </div>
                  {{ size_chart }}
                  {% assign guidelineShowed = true %}
                {%- else -%}
                  <span class="radio__legend__label">{{ option.name | escape_once }}:</span>
                  <span data-option-value data-swapper-target>{{ current_value }}</span>
                {%- endif -%}
                {% comment %} <span class="radio__legend__label">{{ option.name | escape_once }}</span> {% endcomment %}
                {% comment %} <span data-option-value data-swapper-target>{{ current_value }}</span> {% endcomment %}
              </legend>
              {%- if is_swatch_option -%}
                {%- assign lock_width_class = 'radio__inputs--swatch' -%}
              {%- endif -%}
              <div class="radio__inputs {{ lock_width_class }}">
                {%- for value in option.values -%}
                  {%- capture input_id -%}{{ product.id }}-{{ block.id }}-{{ option.name | escape_once }}-{{ value | escape_once }}{%- endcapture -%}

                  {%- if is_swatch_option -%}
                    <radio-swatch class="swatch__button{% if settings.swatches_squares %} swatch__button--square{% endif %}">
                      <input
                        type="radio"
                        data-swatch-input
                        name="options[{{ option.name | escape_once }}]"
                        value="{{ value | escape_once }}"
                        id="{{ input_id }}"
                        form="{{ uniq_id }}"
                        {% if value == current_value -%}
                          checked
                        {%- endif %}
                      >
                      <label
                        for="{{ input_id }}"
                        data-swatch="{{ value | escape_once }}"
                        data-swapper-hover="{{ value | escape_once }}"
                      >
                        <span class="visually-hidden value">{{ value | escape_once }}</span>
                        <span class="visually-hidden">
                          {{- 'products.product.variant_sold_out_or_unavailable' | t -}}
                        </span>
                      </label>
                    </radio-swatch>

                  {%- else -%}
                    {%- comment -%} radio button {%- endcomment -%}
                    <span class="radio__button">
                      <input
                        type="radio"
                        name="options[{{ option.name | escape_once }}]"
                        value="{{ value | escape_once }}"
                        id="{{ input_id }}"
                        form="{{ uniq_id }}"
                        {% if value == current_value -%}
                          checked
                        {%- endif %}
                      >
                      <label for="{{ input_id }}">
                        <span>{{ value | escape_once }}</span>
                        <span class="visually-hidden">
                          {{- 'products.product.variant_sold_out_or_unavailable' | t -}}
                        </span>
                      </label>
                    </span>
                  {%- endif -%}
                {%- endfor -%}
              </div>
            </fieldset>
          {%- else -%}
            <fieldset class="select__fieldset">
              {%- capture input_id -%}{{ product.id }}-option-{{ option.position }}{%- endcapture -%}
              <legend class="radio__legend">
                <span class="radio__legend__label" id="{{ uniq_id }}-select-{{ option.name | handle }}-label">
                  {{ option.name | escape_once }}
                </span>
              </legend>

              <popout-select>
                <div class="select-popout" data-popout data-popout-prevent="true">
                  <button
                    type="button"
                    class="select-popout__toggle"
                    aria-expanded="false"
                    aria-controls="{{ uniq_id }}-select-{{ option.name | handle }}"
                    aria-labelledby="{{ uniq_id }}-select-{{ option.name | handle }}-label"
                    data-popout-toggle
                  >
                    {{ option.selected_value }}
                    {%- render 'icon-core-chevron-down' -%}
                  </button>

                  <ul id="{{ uniq_id }}-select-{{ option.name | handle }}" class="select-popout__list" data-popout-list>
                    {%- for value in option.values -%}
                      <li class="select-popout__item {% if option.selected_value == value %}select-popout__item--current{% endif %}">
                        <a
                          class="select-popout__option"
                          href="#"
                          {%- if option.selected_value == value -%}
                            aria-current="true"
                          {%- endif -%}
                          data-value="{{ value | escape_once }}"
                          data-popout-option
                        >
                          <span>
                            {{ value | escape_once }}
                          </span>
                        </a>
                      </li>
                    {%- endfor -%}
                  </ul>

                  <input
                    type="hidden"
                    name="options[{{ option.name | escape_once }}]"
                    id="{{ input_id }}"
                    value="{{ option.selected_value | escape_once }}"
                    form="{{ uniq_id }}"
                    data-popout-input
                    data-single-option-selector
                    data-index="option{{ option.position }}"
                  >
                </div>
              </popout-select>
            </fieldset>
          {%- endif -%}
        </div>
      {%- endfor -%}
    </div>
  {%- endunless -%}

  {% if product.metafields.custom.engraving_character_limit != blank %}
    {% render 'engraving-pdp' %}
  {% endif %}
    <script>
    // Initialize MicroModal for size chart popup
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof MicroModal !== 'undefined') {
        MicroModal.init({
          disableScroll: true,
          openTrigger: 'data-popup-{{ section.id }}',
          onShow: (modal, el, event) => {
            event.preventDefault();
            const firstFocus = modal.querySelector('button, [href], select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocus) {
              firstFocus.focus();
            }
          },
          onClose: (modal, el, event) => {
            event.preventDefault();
            if (el) {
              el.focus();
            }
          }
        });
      }
    });
  </script>
  <noscript>
    <select
      name="id"
      class="no-js"
      data-product-select
      aria-label="{{ product.options_with_values | map: 'name' | uniq | join: ', ' | strip_html | escape }}"
    >
      {%- for variant in product.variants -%}
        <option
          {% if variant == current_variant %}
            selected="selected"
          {% endif %}
          {% unless variant.available %}
            disabled="disabled"
          {% endunless %}
          value="{{ variant.id }}"
        >
          {{ variant.title }}
        </option>
      {%- endfor -%}
    </select>
  </noscript>
</div>
